<template>
	<div class="page home-page cam" data-name="my-home">
                <div class="navbar">
                    <div class="navbar-inner">
                        <div class="left">
                            <a class="panel-open" href="#">
                                <i class="f7-icons icon-menu"></i>
                            </a>
                        </div>
                        <div class="title">Home</div>
                    </div>
                </div>

                <!--<div class="toolbar toolbar-bottom">
                    <div class="toolbar-inner">
                        <a class="btn-cs" href="#" id='openCamList'>
                            list
                        </a>
                    </div>
                </div>-->
                <div class="toolbar toolbar-bottom">
                    <div class="toolbar-inner">
                        <a class="btn-cs" href="#" id='connectCam'>
                            LIVE
                        </a>
                    </div>
                </div>
				

                <div class="page-content">
					<div class="position_map ">
						<div class="map" id="map"></div>
					</div>
                    <!--<div class="inner-content">
                     
                        <img class="main-bg" src="./resources/images/cam.svg" alt="main">
					
                        <p class="text-content">Select in the connection settings Wi-Fi your
dashcam and click the LIVE button.</p>
						<br><a href="/my-hints/">How to connect?</a>
                    </div>-->
                </div>
            </div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {};            

            return ret;
        },
		methods: {			
			feedCommand: function(hex) {
				var self = this;					
				
				//7802F8334207
				//if(self.phoneMacAddress != '00.00.00.00.00.00'){
					//self.$app.preloader.show();
					
					//let macAddress = self.phoneMacAddress.replace(/[^A-Za-z0-9]/g, "");
					//macAddress = macAddress.substr(1,macAddress.length -2);
					//App.dialog.alert(self.phoneMacAddress);
					self.socket.open(
					  "192.168.43.1",
					  7000,
					  function() {		
						//self.writeToCam("FFF0275D0100000010010006" + macAddress);
						App.dialog.alert("connected");
					
						//self.writeToCam(hex);										
					  },
					  function(errorMessage) {
						//self.$app.preloader.hide();
						App.dialog.alert('er:'+errorMessage);	
						// invoked after unsuccessful opening of socket
					});
				//}else{
					//App.dialog.alert('Something wrong.');						
				//}					
			},
			openLive: function(){		
				var self = this;    
					self.$app.preloader.show();
							WifiWizard2.getConnectedSSID().then(response => {	
								let mySSID = JSON.stringify(response);
								var pattern = /AUTO-VOX/i;
								var pattern1 = /M-/i;
								var pattern2 = /ATGA/i;
								
								self.$app.preloader.hide();		
								if ((pattern.test(mySSID) || pattern1.test(mySSID) || pattern2.test(mySSID))) {	
									VideoPlayer.play(API_LIVE_STREAM);									
								}else{					
									self.$app.dialog.alert('Something wrong.');									
								}					
							}).catch((error) => {
								self.$app.preloader.hide();		
								self.$app.dialog.alert('Please check DashCam connection and turn on location permission on your device');						
							});
			},		
            getGPS: function(){					
				var self = this;  
				
                self.$app.preloader.show();
				self.$app.methods.getGPSData().then(response => {
					/*self.$app.methods.setInStorage({name: 'mediaVideoList', data: response});
                    self.$setState({
                        ShowVideosList: true,
                    });
                    self.$app.utils.nextFrame(()=>{
                        self.initVideosList(response);
                    });	*/					
					self.$app.preloader.hide(); 	
					self.$app.dialog.alert(response);
				}, error => {
					self.$app.preloader.hide(); 
					console.log('Please check connect to Dashcam');
					self.$app.dialog.alert(error);
				});
			}
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;    
				var page = page.$el.find('.page-content'); 
				
				
				
				
				//self.$app.preloader.show();
				self.socket = new Socket();	
				
				self.socket.onData = function(data) {	
					//App.dialog.alert(data);			
					let convertedData = data.reduce((acc, item) => {
					//App.dialog.alert(item);
					  let code = item.toString(16);
					  let formattedCode = ('0' + code).slice(-2);
					  return acc + formattedCode;
					}, '');
					App.dialog.alert(convertedData);
					//self.parseHex(convertedData);
					
				  // invoked after new batch of data is received (typed array of bytes Uint8Array)
				};
				self.socket.onError = function(errorMessage) {
					self.$app.preloader.hide();
					App.dialog.alert('Can not change this state.');
				  // invoked after error occurs during connection
				};
				self.socket.onClose = function(hasError) {
					self.$app.preloader.hide();
					self.checkTotal();
					
					App.dialog.alert('Operation success');
				  // invoked after connection close
				};		
				
				
				var myPage = $$('.cam');
				
				let permissions = cordova.plugins.permissions;
				
				//WifiWizard.getCurrentSSID(self.ssidHandler, self.fail);
								
				/*WifiWizard2.getWifiRouterIP().then(curid2 => {						
					App.dialog.alert(JSON.stringify(curid2));
				});*/
				
				myPage.on('click', '#connectCam', function(e){
					self.feedCommand('FFF0000001000000800F0000');		
					//self.getGPS();
					//App.dialog.alert('This feature is in development.');
				});
				

                /*page.on('click', '.pb-standalone-dark', function(e){
					self.PhotoBrowserObj.open();
				});*/
						
				
				//page.on('click', '#connectCam', function(e){				
				//$$('#connectCam').on('click', function() {    
					
					//window.plugins.videoPlayer.play(API_LIVE_STREAM);
				//});				
			}
		}
    };
</script>
    