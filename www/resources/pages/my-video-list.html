<template>
	<div data-name="my-video-list" class="page gallery my-video-list">
		<div class="navbar">
			<span data-progress="0" class="progressbar display-none" id="demo-inline-progressbar"></span>
			<div class="navbar-inner">
				<div class="left">
					<a href="#" class="back link">
						<i class="f7-icons icon-left"></i>
					</a>
				</div>
				<div class="title">Videos</div>
				<div class="right">
					<a href="#" class="">
						<i class="material-icons md-36">file_download</i>
					</a>
				</div>
				
			</div>
		</div>
		<div >
			<!-- First tab, active  ptr-content-->
			<div class="page-content" id="video">
				<div class="block">
					
					<!--<div class="ptr-preloader">
						<div class="preloader"></div>
						<div class="ptr-arrow"></div>
					</div><div class="list virtual-list video-list media-list no-hairlines">-->
					
					{{#if ShowVideoList}}
						<div key="VirtualVideoList" class="list media-list virtual-list no-margin no-chevron videosList">
					
						</div> 
					{{/if}}
									
				
					
					<!--</div>-->					
				</div>
			</div>
			
		</div>
	</div>
</template>

<script>
  // script must return component object
    return {
        data: function () {
            var self = this;
			var ret = {
			//loadedChildren: [],
				IsCheckAll: false,
				photoBrowserArr: [],
                VirtualNormalList: false,
                VirtualVideoList: false,
				ShowNormalList: false,	
				ShowVideoList: false,	
            }; 			
			
			if (self.$route.query.date) {
				ret.folderDate = self.$route.query.date;
            }
			if (self.$route.query.type) {
				ret.folderType = self.$route.query.type;
            }
            return ret;
        },
        methods: {
			showMediaFile: function(fileName){
					
				var self = this; 
				
				/*var fullPathToFilePrivate = cordova.file.applicationDirectory + 'www/resources/manual/DC100-user-guide.pdf';*/
				var fullPathToFilePrivate = 'file:///data/user/0/com.quiktrak.quiktrak_dashcam/files/'+fileName;
				var externalDirEntry;
				
				window.resolveLocalFileSystemURL(cordova.file.externalDataDirectory, function success(dirEntry) {
					externalDirEntry = dirEntry;
				},function (e) {
					self.$app.dialog.alert('error dir '+JSON.stringify(e));
				});
				
				window.resolveLocalFileSystemURL(fullPathToFilePrivate, function onSuccess(fileEntry)
				{
					
					fileEntry.copyTo(externalDirEntry, 'myfile.mp4',
						function(e)
						{
							self.viewFile(e.nativeURL);
						},
						function()
						{
							self.$app.dialog.alert('copying FAILED');
						});
				}, function (e) { self.$app.dialog.alert(JSON.stringify(e)); });
			},			
			viewFile: function(url){
				if (cordova && cordova.plugins.fileOpener2) {
					cordova.plugins.fileOpener2.open(
						url, // You can also use a Cordova-style file uri: cdvfile://localhost/persistent/Downloads/starwars.pdf
						'video/mp4',
						{
							error: function (e) {
								self.$app.dialog.alert('Error status: ' + e.status + ' - Error message: ' + e.message);
							},
							success: function () {
								
								console.log('file opened successfully');
							}
						}
					);
				}
			},		
            getGalleryList: function(){
					
				var self = this;  
				
                self.$app.preloader.show();
				self.$app.methods.getRecordVideoList(self.folderDate, self.folderType).then(response => {				
					//console.log(response);
					self.$app.methods.setInStorage({name: 'mediaVideoList', data: response});
                    self.$setState({
                        ShowVideoList: true,
                    });
                    self.$app.utils.nextFrame(()=>{
                        self.initVideoList(response);
                    });					
					self.$app.preloader.hide(); 	
				}, error => {
					self.$app.preloader.hide(); 
					console.log('Please check connect to Dashcam');
                    //self.$app.dialog.alert('Something wrong.');
				});
				

            },
			 downloadFile: function(data){
					
				var self = this;  
				
					
					//self.$app.dialog.alert(data);
                //self.$app.preloader.show();
				
				self.$app.methods.downloadMedia(data, self.folderType).then(response => {	
				
					self.$app.preloader.hide(); 		
					$$('.view-main #demo-inline-progressbar').addClass('display-none');
					self.$app.dialog.alert('File uploaded');
					self.showMediaFile(response);
				}, error => {
					self.$app.preloader.hide(); 
					console.log('Please check connect to Dashcam');
                    //self.$app.dialog.alert('Something wrong.');
				});
				

            },
						
			
            initVideoList: function(videoListArr = []){
                var self = this;
                
                var listEl = self.$el.find('.videosList');   
                var videoList = self.$app.methods.getFromStorage("mediaVideoList");
				
                self.VirtualVideoList = App.virtualList.create({
                    el: listEl, 
                    setListHeight: false,
                    // search item by item
                    /*searchAll: function (query, items) {
                        var found = [];
                        query = query.trim().toLowerCase();   
                        for (var i = 0; i < items.length; i++) {
                            if (items[i].AccountName.toLowerCase().indexOf(query) >= 0 || 
                                items[i].EMail.toLowerCase().indexOf(query) >= 0 ||                                
                                query === '') found.push(i);
                        }
                        return found; //return array with mathced indexes
						let found = [];
						for (let i = 0; i < items.length; i++) {
							if (items[i].title.toLowerCase().indexOf(query.toLowerCase()) >= 0 || query.trim() === '') found.push(i);
						}
						return found;
                    },*/
                    //List of array items
					
                    items: videoList,
                    height: function(item){
                        let height = 108;
                        
                        return height;
                    },
                    // Display the each item using Template7 template parameter
                    renderItem: function (item, index) {                 
                        var ret = '';
						
						ret += '<li>';
						ret += '  <a href="#" data-name="'+item.name+'" class="item-link item-content dwnl-file">';
						ret += '	<div class="item-media"><img src="./resources/images/file_1.svg" width="80"/></div>';
						ret += '	<div class="item-inner">';
						ret += '	  <div class="item-title-row">';
						ret += '		<div class="item-title">'+item.name+'</div>';
						ret += '		<div class="item-after"><i class="material-icons md-36">play_for_work</i></div>';
						ret += '	  </div>';
						ret += '	  <div class="item-subtitle">size: '+item.size+'</div>';
						ret += '	  <div class="item-text">'+item.modifiedDate+'</div>';
						ret += '	</div>';
						ret += '	</a>';
						ret += '</li>';
						
												
						return ret;
                    }
                });				
            },
        },
        on: {
            pageInit: function (e, page) {  
				var self = this;                                              
                console.log('page init');
				
                self.getGalleryList();	

				var page = page.$el.find('.page-content'); 

                page.on('click', '.pb-standalone-dark', function(e){
					self.PhotoBrowserObj.open($(this).attr('data-index'));
				});
				
				page.on('taphold', '.item-path', function(e){
					self.$setState({
                        IsCheckAll: true,
                    });
					$('.photo-check-item').removeClass('display-none');
				});
				
				
				page.on('click', '.dwnl-file', function() {
						let fileName = $(this).attr('data-name');
						self.downloadFile(fileName);					
					});
					
					
				var myPage = $$('.my-videos');
				
				myPage.on('click', '.toggle-check-item', function(e){
					let newState = !self.IsCheckAll;
					self.$setState({
                        IsCheckAll: newState,
                    });
					$('.photo-check-item').toggleClass('display-none');
				});				
							
					
				myPage.on('click', '.download-items', function(e){
				
					var arrItems = [];			
					
					//var currentCamera = self.$app.methods.getFromStorage("currentCamera");
					
				
					var downloadItems = $$('[name="photo-check"]');
					downloadItems.forEach(function() {
						if($(this).is(":checked")){
							let objItem = {
								name: $(this).attr('file-name'),
								dir: 'dashcam',
								url: $(this).val()
							}
							arrItems.push(objItem);
						}											
						$(this).removeAttr("checked");
					});
					
					self.$setState({
                        IsCheckAll: false,
                    });
										
					$('.photo-check-item').toggleClass('display-none');
					
					self.$app.methods.downloadFiles(arrItems);
					arrItems.length = 0;
				});	
								
				
				
				// Pull to refresh content
				var $ptrContent = $$('.ptr-content');
				// Add 'refresh' listener on it
				$ptrContent.on('ptr:refresh', function (e) {
				  // Emulate 2s loading
				  setTimeout(function () { // Prepend new list element
					
					self.getGalleryList();	
					//$ptrContent.find('ul').prepend(itemHTML);
					// When loading done, we need to reset it
					App.ptr.done(); // or e.detail();
				  }, 2000);
				});
			}
		}
    };
</script>